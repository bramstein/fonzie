var woff = 'd09GRgABAAAAAAOwAA8AAAAABTAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABWAAAABwA' +
           'AAAcYWCdE0dERUYAAAF0AAAAHAAAACAAMgAET1MvMgAAAZAAAABAAAAAVmK/U2NjbWFwAAAB0AAA' +
           'AEkAAAFKv6sklGN2dCAAAAIcAAAABAAAAAQAiAoiZ2FzcAAAAiAAAAAIAAAACP//AANnbHlmAAAC' +
           'KAAAABYAAAAgAAJqBmhlYWQAAAJAAAAAKAAAADb29XMVaGhlYQAAAmgAAAAaAAAAJA2GFNJobXR4' +
           'AAAChAAAABQAAAAUQPoAAGxvY2EAAAKYAAAADAAAAAwACAAQbWF4cAAAAqQAAAAdAAAAIABIAAdu' +
           'YW1lAAACxAAAALUAAAFAFccyQ3Bvc3QAAAN8AAAAKQAAAELmXGWbd2ViZgAAA6gAAAAGAAAABuaN' +
           'T8UAAAABAAAAAMmJbzEAAAAAy+uW1QAAAADL65cMeNpjYGRgYOADYgkGEGBiYARCFjAG8RgABHYA' +
           'N3jaY2AUqWWcwMDKwMJqzDqLgYFRDkIzX2dIYxJiYGBiYOVkgAFGBiQQkOaawuDAkPmAgS3tXxrD' +
           'DmQ1AJuHCdB42mNgYGBmgGAZBkYGEHAB8hjBfBYGDSDNBqQZGZgYMh8w/P8P5IPp/7MUWKDqgYCR' +
           'jQHOYWQCEkwMqICRgXqAmWFQAgADwwkeAAAAAIgKIgAAAAH//wACeNpjYGRAAoYMDAg+MwODJTMA' +
           'BEQAcwAAeNpjYGRgYADi6ovL58Tz23xl4OZgAIHTr6fzINNQwMHABKIAK60JAHjaY2BkYOA58+cM' +
           'ww4JBihgZEAFrABlDQN4AAAIAAAACAAAAAgAAAAYAAAAEPoAAAAAAAAAAAAAAAgAEHjaY2BkYGBg' +
           'ZWBhANEMDExAzAhmO4D5DAADOwBQAAAAeNpVj7EOAVEQRc/aJSiUIqr3A4SVVWyp0GkUJLoVSyRC' +
           'sij8gtpX+BL+yt23T5ZiZu6dd+fOPKDOFh8vaODRBIcrtMQK7DOh43BAl5XDVdpcHK5JfXf4pf7D' +
           '4TcDnmRcOZCqzpV3liViU04c5ZHXTP0UQ0hfM4ZYUc4VfKSXHpEiFBoq/yr+vRe2e2Zvdxipc99S' +
           'v1Re6+/FBd/3vLsRm8nj5jYaRaT9oTSxYmyvtPs/g8coKwAAAHjaY2BiwA9YGRgYmRiZGXwYWdjS' +
           'cyoLMgwhlBF7aV6mq4GBAQBcTgc/AAAAAAFPxeaMAAA=',
    ttf = 'AAEAAAAPAIAAAwBwRkZUTWFgnRMAAAD8AAAAHEdERUYAMgAEAAABGAAAACBPUy8yYr9TYwAAATgA' +
          'AABWY21hcL+rJJQAAAGQAAABSmN2dCAAiAoiAAAC3AAAAARnYXNw//8AAwAAAuAAAAAIZ2x5ZgAC' +
          'agYAAALoAAAAIGhlYWT29XMVAAADCAAAADZoaGVhDYYU0gAAA0AAAAAkaG10eED6AAAAAANkAAAA' +
          'FGxvY2EACAAQAAADeAAAAAxtYXhwAEgABwAAA4QAAAAgbmFtZRXHMkMAAAOkAAABQHBvc3TmXGWb' +
          'AAAE5AAAAEJ3ZWJm5o1PxQAABSgAAAAGAAAAAQAAAADJiW8xAAAAAMvrltUAAAAAy+uXDAABAAAA' +
          'DgAAABgAAAAAAAIAAQABAAQAAQAEAAAAAgAAAAEUfQGQAAUABAUzBZoAAAEeBTMFmgAAA9cAZgIS' +
          'AAACAAUJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAQABp4AAGZv5mALgAAAAAAAAAAQAAAAAA' +
          'AAAAAAMAAAADAAAAHAABAAAAAABEAAMAAQAAABwABAAoAAAABgAEAAEAAgBp4AD//wAAAGngAP//' +
          '/5ogBAABAAAAAAAAAAABBgAAAQAAAAAAAAABAgAAAAIAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAA' +
          'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
          'AAAAAAAAAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
          'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +
          'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIgKIgAAAAH/' +
          '/wACAAEAAAAAAAAAAAAAAAAxAAABAAAAAAAAAAAAAwAAOQMAAQAAAAEAAHvRp5xfDzz1AAsIAAAA' +
          'AADL65cMAAAAAMvrlwwAAAAAAAAAAAAAAAgAAgAAAAAAAAABAAAMzPzMALgYAAAAAAAAAAABAAAA' +
          'AAAAAAAAAAAAAAAABQgAAAAIAAAACAAAABgAAAAQ+gAAAAAAAAAAAAAACAAQAAEAAAAFAAQAAQAA' +
          'AAAAAgAAAAEAAQAAAEAAAAAAAAAAAAAIAGYAAwABBAkAAQAKAAAAAwABBAkAAgAOAAoAAwABBAkA' +
          'AwBCABgAAwABBAkABAAaAFoAAwABBAkABQAWAHQAAwABBAkABgAKAIoAAwABBAkAyAAWAJQAAwAB' +
          'BAkAyQAwAKoAcgB1AGwAZQByAFIAZQBnAHUAbABhAHIARgBvAG4AdABGAG8AcgBnAGUAIAAyAC4A' +
          'MAAgADoAIAByAHUAbABlAHIAIAA6ACAAMwAwAC0ANQAtADIAMAAxADIAcgB1AGwAZQByACAAUgBl' +
          'AGcAdQBsAGEAcgBWAGUAcgBzAGkAbwBuACAAMQAuADAAcgB1AGwAZQByAFcAZQBiAGYAbwBuAHQA' +
          'IAAxAC4AMABXAGUAZAAgAE0AYQB5ACAAMwAwACAAMAA1ADoAMgAxADoAMQA2ACAAMgAwADEAMgAC' +
          'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAECAQMATAEEBmdseXBoMQZnbHlwaDIH' +
          'dW5pRTAwMAAAAAFPxeaMAAA=';

var logger = document.createElement('div');

function log(str) {
  logger.innerHTML += '<br>' + str;

}

document.body.appendChild(logger);

function createFontFace(font) {
    var head = document.querySelector('head'),
        style = document.createElement('style');

    style.textContent = "@font-face { font-family: '" + font.family + "'; src: url(" + font.src.woff + ") format('woff'), url(" + font.src.ttf + ") format('truetype'); font-weight: " + font.weight + "; font-style: " + font.style + "; }";

    head.appendChild(style);
}

function loadFont(font) {
    var ruler = document.createElement('span'),
        timeout = 3000;

    ruler.textContent = 'iii';
    ruler.style.cssText = 'display: inline-block; font-size: 20px; font-family: monospace; visibility: hidden;';

    document.body.appendChild(ruler);

    function monitor(callback, timeout) {
        var running = true,
            previousWidth = ruler.clientWidth;

        window.setTimeout(function() {
            running = false;
        }, timeout);

        function monitorAux(callback) {
            window.setTimeout(function() {
                if (running) {
                    var currentWidth = ruler.clientWidth;
                    if (currentWidth !== previousWidth) {
                        log(currentWidth + ' ' + previousWidth);
                        monitorAux(callback);
                        //callback(null, currentWidth, previousWidth);
                    } else {
                        monitorAux(callback);
                    }
                } else {
                    callback('timeout');
                }
            }, 25);
        }
        monitorAux(callback);
    }

    monitor(function(err, width, monospaceWidth) {
        if (err || width !== 180) {
            // Our built in font has not loaded or something is wrong
            //document.body.removeChild(ruler);
            font.inactive();
            log('timeout due to ruler font' + err + width + ' ' + monospaceWidth);
        } else {
            createFontFace(font);
            log('loading font');

            monitor(function(err, width, previousWidth) {
                if (err) {
                    log('Other: font timeout');
                    font.inactive();
                } else {
                    if (previousWidth !== 180) {
                        // Webkit changes font width twice, first it falls back to the generic
                        // font-family in the stack (in our case monospace) when loading the
                        // font, and then it changes width again once the font has actually loaded.
                        if (width === 180 && previousWidth === monospaceWidth) {
                            // Webkit tried to load the font, changed the width to that of our monospace
                            // font and then failed to load the external font. It then fell back on our
                            // ruler font. We know for sure font loading failed.
                            log('Webkit: font load failed');
                            font.inactive();
                        } else {
                            log('Webkit: font active');
                            font.active();
                        }
                    } else {
                        // All other browsers only change width when the font has loaded, so we're done here.
                        log('Other: font active');
                        font.active();
                    }
                }
                //document.body.removeChild(ruler);
            }, timeout);
            
            ruler.style.fontFamily = "'" + font.family + "', '__ruler__', monospace";
            log(ruler.clientWidth);
            font.loading();
        }
    }, timeout);

    ruler.style.fontFamily = "'__ruler__', monospace";
}

createFontFace({
    family: '__ruler__',
    weight: 'normal',
    style: 'normal',
    src: {
        woff: 'data:application/x-font-woff;base64,' + woff,
        ttf: 'data:font/truetype;base64,' + ttf
    }
});

window.document.addEventListener('DOMContentLoaded', function() {
    loadFont({
        family: 'PT Sans',
        weight: 'normal',
        style: 'normal',
        src: {
            woff: 'fonts/ptsans/PTS55F_W.woff',
            ttf: 'fonts/ptsans/PTS55F_W.ttf'
        },
        loading: function() {
            console.log('font loading');
        },
        inactive: function() {
            console.log('font inactive');
        },
        active: function() {
            console.log('font active');
        }
    });
}, false);
